<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>소셜로그인 디버그 모드</title>
    <style>
      body { padding: 20px; font-family: sans-serif; }
      #result {
        margin-top: 20px;
        padding: 10px;
        border: 2px solid green;
        background-color: #e8f5e9;
        word-break: break-all;
        display: none; /* 평소엔 숨김 */
      }
      .debug-msg {
        color: red;
        font-weight: bold;
        margin-bottom: 10px;
      }
    </style>
  </head>
  <body>
    <h1>구글 로그인 (디버그 모드)</h1>
    
    <div id="status" class="debug-msg">상태: 페이지 로드 중...</div>

    <button onclick="googleLogin()" style="padding: 10px 20px; cursor: pointer;">
      구글 로그인 버튼 (팝업 띄우기)
    </button>

    <div id="result">
      <h3>토큰 수신 성공!</h3>
      <p>아래 토큰이 부모 창으로 전달됩니다:</p>
      <code id="tokenText"></code>
    </div>

    <script>
      const statusDiv = document.getElementById('status');

      window.onload = function () {
        statusDiv.innerText = "상태: 페이지 로드 완료 (JS 실행됨)";
        
        const urlParams = new URLSearchParams(window.location.search);
        const accessToken = urlParams.get('accessToken');

        // 1. 리다이렉트되어 돌아온 경우 (토큰 있음)
        if (accessToken) {
            statusDiv.innerText = "상태: 토큰 감지됨! (팝업 모드)";
            console.log("토큰 발견:", accessToken);

            // 토큰을 화면에 보여줌 (디버깅용)
            document.getElementById('result').style.display = 'block';
            document.getElementById('tokenText').innerText = accessToken;

            if (window.opener) {
                // 부모 창으로 전송
                window.opener.postMessage({ accessToken: accessToken }, '*');
                console.log("부모 창으로 메시지 전송 완료");
                
                // ★ 중요: 테스트를 위해 자동 닫기를 주석 처리함 ★
                // window.close(); 
                alert("로그인 성공! 확인을 누르면 창이 닫힙니다.");
                window.close(); // 알림창 확인 후 닫힘
            } else {
                statusDiv.innerText = "상태: 토큰은 있지만 부모 창(opener)이 없음. (새 탭에서 열었나요?)";
            }
        } else {
            // 2. 처음 접속한 경우 (버튼 누르기 전)
            statusDiv.innerText = "상태: 일반 접속 (로그인 버튼을 눌러보세요)";
        }
      };

      // --- 로그인 팝업 열기 함수 ---
      function googleLogin() {
        // 백엔드 주소가 정확한지 확인 필수
        // const backendUrl =
        
        const width = 500;
        const height = 600;
        const left = window.screen.width / 2 - width / 2;
        const top = window.screen.height / 2 - height / 2;

        window.open(
          backendUrl,
          'google_login_popup',
          `width=${width},height=${height},top=${top},left=${left},status=no,toolbar=no,menubar=no`,
        );
      }

      // --- 부모 창에서 메시지 받기 ---
      window.addEventListener('message', (event) => {
          console.log('메시지 수신:', event.data);
          if (event.data && event.data.accessToken) {
            alert("메인 창: 로그인 성공! 토큰을 받았습니다.");
            localStorage.setItem('accessToken', event.data.accessToken);
            document.getElementById('tokenText').innerText = event.data.accessToken;
            document.getElementById('result').style.display = 'block';
          }
      });
    </script>
  </body>
</html>

<!-- <!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>???</title>
  </head>
  <body>
    <h1>왜 암거도 안뜨노?</h1>
  </body>
</html> -->
